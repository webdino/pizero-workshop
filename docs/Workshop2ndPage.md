<h1>やってみよう! <br>microSDカードの編集だけでできる<br> Iot環境データ収集</h1>
<!-- # やってみよう! micro SDカードの編集だけでできる IOT環境データ収集-->

#### もっと便利につかってみよう 応用編

ここからは、より便利につかっていくためのくわしい説明をしていきます。

### 計測間隔を設定してみる

初期設定では60秒（60000ミリ秒）ごとに計測しています。

`config.js`ファイルの、`"INTERVAL_MILLISEC": 60000,`の、`60000`の部分を変更すると計測間隔を変えることができます。

この場合アップロード先のクラウドサービス側が、そのデータ計測の記録間隔を受け付けられるかどうかが問題になってきます。Machinist では、同じ時刻（分単位）に記録したデータは、後で送ったもので上書きされます。したがって、１分間に１計測よりたくさんの記録ができないことに注意してください。（あとで紹介する別のクラウドサービス「Ambient」は、記録間隔は秒単位ですが、１日辺りのデータ記録上限が3000件です。したがって定期送信する場合は３０秒間隔程度が最短となることに注意してください。）
<!--　https://ambidata.io/refs/spec/ -->

### データ送信間隔を設定してみる

複数回のデータ計測後に、計測値をまとめて送信することができます。つまり、センシングをするたびに毎回計測データをクラウドに送信するのではなく、ある程度計測データをストックし、まとめてクラウドに送信するのです。

`config.js`ファイルの編集で、`"MULTIPLE": 1,`の行の、`1`の部分を変更するとデータ送信間隔を変えることができます。

これを`２`以上に設定すると、グラフへのデータの反映にタイムラグが生じますが、総合的なデータ通信量を減らすことが出来るので、とくに長期間のデータ収集の場合は、これを大きめに設定するとよいでしょう（Iotでは実際の計測場所の電源や電波などの条件からSIM通信の利用を選択することがあり、このような場合には通信量を減らすことは大きなメリットがあります。）

なお、`MULTIPLE:`をどのような設定値にしていても、システムを起動した直後の一回目の計測データは、直ちにデータ送信されるようになっています。

### Machinistのいろいろな機能をつかってみる

- グラフ表示の使い方
  - 各メトリックを開く
  - 最新値、1日などの切り替え
    - 最新値以外の表示では一定時間の結果を算術平均した丸め値の表示となること
    - その丸め値の計算は即座に行われるものだけじゃなく、すぐに描画に反映されないことがある。あくまでも過去の大きな変動観察用
    - 長期間の表示では丸められている結果、最小値や最大値が欲しいケースに使えないことに注意
  - 最新値、1日などの切り替え
  - 最新値、1日などの切り替え
  - 表示する時間の切り替え
- 監視機能
  1. アクションにメール通知を登録する https://app.machinist.iij.jp/action-settings
  2. 監視設定を追加する https://app.machinist.iij.jp/monitor/settings
    - 死活監視 (メトリックが15分途切れたら通知)
    - 閾値監視 (メトリックの直近 5 分平均などが一定値を超えたら通知)
- カスタムチャート・ダッシュボード
  - 高校生向けでは無しでも良いが、大人向けに説明を
  - カスタムチャートの公開やダッシュボードで監視ディスプレイを設置する
- IFTTT 連携 - ここには書き切れないが LINE 通知などするために本当は必要な話


通知メールの例 (死活監視)

```
送信者: machinist-noreply@iij.ad.jp
タイトル: "Machinist監視通知"
-----
監視状態に変化がありました
 (YYYY/MM/DD HH:MM:SS)

エージェント: xxxxxxxx
メトリック:   2JCIE-BU / 温度
タグ:         {}
状態:         未設定 -> 計測中断！
条件:         死活監視

詳細は以下のページよりご確認ください。
https://app.machinist.iij.jp/#/metrics/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

machinist-noreply@iij.ad.jp は送信専用のメールアドレスです
```

通知メールの例 (しきい値)

```
送信者: machinist-noreply@iij.ad.jp
タイトル: "Machinist監視通知"
-----
監視状態に変化がありました
 (YYYY/MM/DD HH:MM:SS)

エージェント: xxxxxxxx
メトリック:   2JCIE-BU / 総揮発性有機化合物濃度
タグ:         {}
状態:         未設定 -> 揮発してます！
条件:         1554.0(avg) > 1000.0


詳細は以下のページよりご確認ください。
https://app.machinist.iij.jp/#/metrics/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

machinist-noreply@iij.ad.jp は送信専用のメールアドレスです
```


### 別のクラウドサービス（Ambient）にもアップロードしてみる

Machinistとは別のクラウドサービス、[Ambient]()にもデータをアップロードすることができます。

ユーザアカウントを取得して、チャンネルをつくり、そのチャンネルの`channel id`と`write key`を確認します。

そして再び、`config.js`ファイルの編集です。

`"AMBIENT_CHANNEL": `に`channel_id`の値を入力し、行頭の`//`を削除します。

`"AMBIENT_WRITEKEY": `に`write_key`を入力し、行頭の`//`を削除します。

そして、`"RECORDS": ["CSV","MACHINIST"]`に`"AMBIENT"`を追加し、`"RECORDS": ["CSV","MACHINIST","AMBIENT"]`へと書き換えます。
（または、`"RECORDS": ["CSV","MACHINIST"]`の行の先頭に`//`を挿入し、`//"RECORDS": ["CSV","MACHINIST","AMBIENT"]`の行の先頭の`//`を削除します。


### microSDカードに計測データを保存してみる

計測されたデータはクラウドに送信されるように設定をしていますが、実はmicroSDカードにも保存されています。

`"RECORDS": ["CSV"]` 

予想がつくかと思いますが、この`"CSV"`の部分がmicroSDカードへのデータ保存を設定している部分です。（この部分に`"CSV"`を含めないようにすると、microSDカードへはデータが保存されなくなります。）

microSDカードのなかに保存されたデータに、いまアクセスするためには、一度Raspberry Pi Zeroの電源を切り、また電源をいれて起動させ、すこし時間をおいて（３，４分以上）さらにもう一度電源を切るというステップを経る必要があります。そしてmicroSDカードをパソコンに挿入します。

microSDカードの`/boot/setting/log`フォルダを確認してみましょう。そのなかに`Omron2jcie.csv`というファイルができていますか？


`/boot/setting/log/`には環境センサーなどのpizero-workshopプログラムによる記録データが保存されます。しかしプログラムの事情から、通常はおそらく最新の記録データはみつからないでしょう。その場所には午前０時やシステム起動時に、ある別の場所に保存されているデータがコピーされるのです。したがって、mircoSDカードから最新のデータにアクセスしたい場合は、さきほどのように一度Raspberry Pi Zeroを再起動をさせてコピーされるのをしばらく待ち、そして電源を切ってmicroSDカードへアクセスする必要があります。

また、長期間にわたり計測データを記録すると、（３週間おきに）古いcsvデータが自動でファイル分割され、ファイル名に古い日付の付いたcsvファイルが自動生成されるようになっています。

>ちなみにcsvとはcomma separated valueのことです。つまり「カンマで区切られた値」としてデータを表現し保存する形式です。そのデータが一行一行追記されるので、結果は表のデータになります。エクセルなどであつかうのに適した表計算データです。

### Googleドライブにアップロードする

csvファイルを、定期的にgoogleドライブに自動でアップロードすることができます。


- rclone の使い鷹は取りあえず後回し。設定ファイルを作って下さいだけとして、テンプレートを別途渡す
- rclone されるタイミングは ~~再起動したときと~~ 日付が変わったときだけだった。ワークショップ中にその場で動作確認できない。。。
  - すぐに設置する高校だけ crontab 書き換えるか。。。


<!--
## raspberrypi zeroへアクセス
ここからはくわしい人向けになりますが、hostname otg serial_console
-->