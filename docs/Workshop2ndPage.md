# **SD カードの編集だけでできる** IoT 環境データ収集

## 応用編: もっと便利につかってみよう

ここからは、より便利につかっていくための詳しい説明をしていきます。

### 計測間隔を設定してみる

初期設定では60秒（60000ミリ秒）ごとに計測しています。

`config.js`ファイルの、`intervalMillisec: 60000,`の、`60000`の部分を変更すると計測間隔を変えることができます。

この場合アップロード先のクラウドサービス側が、そのデータ計測の記録間隔を受け付けられるかどうかが問題になってきます。Machinist では、同じ時刻（分単位）に記録したデータは、後で送ったもので上書きされます。したがって、１分間に１計測よりたくさんの記録ができないことに注意してください。（のちに紹介する別のクラウドサービス「Ambient」は、記録間隔は秒単位ですが、１日辺りのデータ記録上限が3000件です。したがって定期送信する場合は３０秒間隔程度が最短となることに注意してください。）

>ちなみに`config.js`はjavascriptプログラムですから、`intervalMillisec: 60000,`の部分は、計算式を入力することができます。例えば１０分ごとに計測させたい場合、`intervalMillisec: 10 * 60 * 1000,`といった具合に記述できるのです。（*は掛け算の記号です）

<!--　https://ambidata.io/refs/spec/ -->

### データ送信間隔を設定してみる

複数回のデータ計測後に、計測値をまとめて送信することができます。つまり、センシングをするたびに毎回計測データをクラウドに送信するのではなく、ある程度計測データをストックし、まとめてクラウドに送信するのです。

`config.js`ファイルの編集で、`machinistBatchQuantity: 1,`の行の、`1`の部分を変更するとデータ送信間隔を変えることができます。

これを`２`以上に設定すると、グラフへのデータの反映にタイムラグが生じますが、総合的なデータ通信量を減らすことが出来るので、とくに長期間のデータ収集の場合は、これを大きめに設定するとよいでしょう（Iotでは実際の計測場所の電源や電波などの条件からSIM通信の利用を選択することがあり、このような場合には通信量を減らすことは大きなメリットがあります。）

なお、`machinistBatchQuantity:`をどのような設定値にしていても、システムを起動した直後の一回目の計測データは、直ちにデータ送信されるようになっています。

### Machinistのいろいろな機能をつかってみる

ここからはMachinistの機能をより詳しく説明していきます。

#### グラフ表示

まず、いろいろなスタイルでグラフ表示をさせてみましょう。

Machinistの画面上部のメニューから「メトリック」にアクセスします。そして、ためしに「二酸化炭素濃度」のグラフをクリックしてみましょう。

すると、二酸化炭素濃度のグラフが表示され、その右上には「折れ線グラフ」「最新値」「現在」「CSVダウンロード」「設定」のメニューがあります。
それぞれのメニューの項目をクリックして、いろいろと試してみましょう。

さて、表示する期間についての説明をしておきます。（ある程度長期のデータが蓄積されないと、よくわからないかもしれません）

Machinistでは、蓄積されたデータのなかで、どの期間のものを選んで表示するかを選択できます。

まず、期間の幅は「最新値」「1日」「一週間」「一ヶ月」「６ヶ月」のいづれかを選択できます。そしてそれが、いつの時点を基準にしたものかを日付で指定できます。

いろいろと試してみてください。

>期間の幅が「最新値」以外の場合、とても多くのデータの描画になってしまうのをさけるために、ある程度のデータを一定期間で平均していくことでデータ数を減らした（省略した）ものが描画されるようです。したがってこの場合は、長期間の変動をおおまかに観察する用途には適していますが、瞬間的な小さい値や大きい値などは、描画に反映されない可能性があることに注意してください。

### 監視機能をつかってみる

さて、長期間データを集めるにあたって、つねにずっとグラフを観察しつづるけるわけにはいきません。

そこでIotではプログラムに監視をさせます。

今回の場合ですと、たとえば揮発性有機化合物濃度が急上昇した場合に、自動でメール通知するなどの監視をさせるのです。また、知らないうちにRaspberry Pi Zeroの電源がきれてしまっていて、データアップロードが何日も前からされていなかった、などということがないように、たとえば１５分間データアップロードがない場合には、自動でメール通知させるなどです。

前者のような監視を「しきい値監視」、後者のような監視を「死活監視」といいます。

Machinistでは、この「しきい値監視」と「死活監視」の機能を提供しています。ここからはそれらを設定してみましょう。

### しきい値監視

まず、しきい値監視です。

はじめに、「アクション」を作成します。<!-- https://app.machinist.iij.jp/action-settings -->　画面上部のメニューから「アクション」にアクセスし、さらに「＋アクションを作成する」をクリックします。

そして「タイプ」で「メール通知」を選び、つづいて「アクション名」を適当に入力して、最後に「TO」にメールアドレスを入力します。

これでアクションが作成されたので、ためしに「テスト実行」をしてみましょう。入力したメールアドレスに、Machinistからテストメールが届きましたか？

つぎに「監視」を設定します。画面上部のメニューから「監視」にアクセスし、さらに「設定」を開き「＋監視設定を作成する」をクリックします。すると「監視設定名」の入力をうながされるので適当に入力します。

これで「監視設定」が追加されましたので、「詳細を見る」をクリックして、その内容を設定していきましょう。

設定するのは「条件」と「監視対象メトリック」です。

ここでは、「メトリックを選択する」で、まず「照度」を選んでみましょう。そして「条件を追加する」で、以下のように設定してみます。

「タイプ」を「しきい値」、「演算子」を「＜」、「値」を「１００」、「値の種別」を「平均値」、「条件一致時の状態名」を「暗くなりました」、「アクション」はさきほど作成したアクションを選びます。

最後に「保存」して、さらに「設定の反映」をクリックします。

これで「しきい値監視」が設定されました。

では、ためしに環境センサーをなにかで覆って、しばらく光を閉ざしてみましょう。 (直近５分間の平均値が、設定した値を下回ったら通知する、という設定をしたので５分ぐらいやってみます。)。上手く監視設定が出来ていれば、次のような通知メールが送信されます。

```
送信者: machinist-noreply@iij.ad.jp
タイトル: "Machinist監視通知"
-----
監視状態に変化がありました
 (YYYY/MM/DD HH:MM:SS)

エージェント: xxxxxxxx
メトリック:   2JCIE-BU / 照度
タグ:         {}
状態:         未設定 -> 暗くなりました
条件:         19.0(avg) < 100.0


詳細は以下のページよりご確認ください。
https://app.machinist.iij.jp/#/metrics/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

machinist-noreply@iij.ad.jp は送信専用のメールアドレスです
```

### 死活監視

つづいては「死活監視」です。

再び「条件を追加する」で、今度は以下のように設定してみます。

「タイプ」を「死活監視」に、「メトリック投稿が途絶えてから検知するまでの時間」を「１５分」に、「条件一致時の状態名」を「データの投稿が途絶えました」、そして「アクション」はさきほど作成したアクションを選びます。

これで、１５分間データアップロードがされない場合には、自動で次のような通知メールが送信されます。

```
送信者: machinist-noreply@iij.ad.jp
タイトル: "Machinist監視通知"
-----
監視状態に変化がありました
 (YYYY/MM/DD HH:MM:SS)

エージェント: xxxxxxxx
メトリック:   2JCIE-BU / 温度
タグ:         {}
状態:         未設定 -> 計測中断！
条件:         死活監視

詳細は以下のページよりご確認ください。
https://app.machinist.iij.jp/#/metrics/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

machinist-noreply@iij.ad.jp は送信専用のメールアドレスです
```

監視機能について詳しくはサービスの説明ページをご覧ください:

- [監視設定の追加](https://machinist.iij.jp/getting-started/getting_started/monitoring.html)
- [監視設定の条件について](https://machinist.iij.jp/getting-started/spec/monitor_setting.html)

### カスタムチャートをつくってみる

Machinistでは、複数のメトリックをひとつのグラフに描画したり、グラフを外部に公開することができます。

「画面上部のメニュー」から「カスタムチャート」にアクセスし、「＋カスタムチャートを作成する」をクリックします。

「チャートの作成」が表示されるので、「チャート名」を適当に入力します。すると、「メトリックの選択」になるので、まずは「温度」と「湿度」を選択して、「保存」しましょう。

これで「温度」と「湿度」が「折れ線グラフ」で描画されました。ためしに「折れ線グラフ」の部分を「散布図」に変更してみましょう。

またグラフの上にマウスカーソルをもってくると、いろいろな情報が表示されます。

つぎに、「チャートの共有」を「有効」にして、「共有リンクを作成する」をクリックしてみましょう。すると、グラフを外部に公開するWEBのURLが作成されます。また同時にWEBサイトにグラフを埋め込むためのHTMLの埋め込みコードも作成されます。

カスタムチャートの作成のオフィシャルドキュメントは以下です。
>カスタムチャートの作成
https://machinist.iij.jp/getting-started/getting_started/custom_chart.html

<!-- 監視ディスプレイ　設置
 -->
<!-- - IFTTT 連携 - ここには書き切れないが LINE 通知などするために本当は必要な話
 -->

### 別のクラウドサービス（Ambient）にもアップロードしてみる

Machinistとは別のクラウドサービス、[Ambient](https://ambidata.io/)にもデータをアップロードすることができます。

ユーザアカウントを取得して、チャンネルをつくり、そのチャンネルの`チャネルID`と`ライトキー`を確認します。

そして再び、`config.js`ファイルの編集です。

`ambientChannelId: `に`チャネルID`の値を入力します。

`ambientWriteKey: `に`ライトキー`を入力します。

>javascriptプログラムでは、行頭に`//`を挿入すると、その行はプログラムとしては無視されます。これをコメントアウトといいまず。つまり`//`のあとにコメントとしてプログラムの説明をかいたり、一時的にその行を無視させるなどして、プログラムの変更を試すのに利用したりします。

### microSDカードに計測データを保存してみる

計測されたデータはクラウドに自動で送信されるように設定されていますが、実はmicroSDカードにも自動で保存されています。

`config.js`の`csvFilename:` の部分です。

予想がつくかと思いますが、この`csvFilename:`の部分がmicroSDカードへのデータの保存を設定している部分です。これはデータを保存するファイル名になりますので、センサーの設置場所などのわかりやすいファイル名にしましょう。またファイルの拡張子は`.csv`としてください。この部分を`""`とすると、microSDカードへはデータが保存されなくなります。）

さて、microSDカードのなかに保存されたデータに、いまアクセスするためには、一度Raspberry Pi Zeroの電源を切り、また電源をいれて起動させ、すこし時間をおいて（３，４分以上）さらにもう一度電源を切るというステップを経る必要があります。そのようにしてから、microSDカードをパソコンに差し替えます。

そして、microSDカードの`/boot/setting/log`フォルダを確認してみましょう。そのなかに`○○○.csv`というファイルができていますか？

`/boot/setting/log/`には環境センサーなどのpizero-workshopプログラムによる記録データが保存されます。しかしプログラムの事情から、通常はおそらく最新の記録データはみつからないでしょう。その場所には午前０時やシステム起動時に、ある別の場所に保存されているデータがコピーされるのです。したがって、mircoSDカードから最新のデータにアクセスしたい場合は、さきほどのように一度Raspberry Pi Zeroを再起動をさせてコピーされるのをしばらく待ち、そして電源を切ってmicroSDカードへアクセスする必要があります。

また、長期間にわたり計測データを記録すると、１週間おきに、古いcsvデータが自動でファイル分割され、ファイル名に古い日付の付いたcsvファイルが自動生成されるようになっています。

>ちなみにcsvとは`comma separated values`のことです。つまり「カンマで区切られた値」としてデータを表現し保存する形式です。そのデータが一行一行追記されるので、データ全体は表のようになります。Excelなどの表計算ソフトであつかうのに適したデータ形式です。

### Googleドライブにアップロードする

csvファイルを、定期的にgoogleドライブに自動でアップロードすることができます。

まずrcloneというソフトウェアの設定ファイルが必要です。この設定ファイルがない場合は、まずお使いのコンピュータに`rclone`をインストールしてください。rcloneを起動してgoogleドライブを使う設定をすると、rcloneの設定ファイルが生成されます。そしてこの設定ファイルをRaspberry Pi Zero のmicroSDカードの`/boot/setting`の中に`rclone.conf`というファイル名でコピーします。

次に `/boot/setting/syncLogConfig.js `ファイルを編集します。

```js
module.exports = [
  {
    type: 'rsync',
    intervalHours: 1,
    source: '/home/pi/pizero-workshop/log/',
    dest: '/boot/setting/log/'
  }
  ,
  {
    type: 'rclone',
    intervalHours: 24,
    rcloneConf: '/boot/setting/rclone.conf',
    source: '/boot/setting/log',
    destService: 'gdrive', //ここをrcloneの設定ファイルの生成のときに入力したgoogle driveに対するサービス名に変更する
    destDir: 'pizero-workshop'
  }
];
```

`syncLogConfig.js`ファイルを以上のように編集します。